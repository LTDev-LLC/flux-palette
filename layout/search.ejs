<% 
  var searchCfg = theme.search || {},
    service = searchCfg.service || 'local',
    upstashCfg = searchCfg.upstash || {},
    supabaseCfg = searchCfg.supabase || {};

  // Pass configuration to the frontend safely
  var frontendConfig = {
    mode: service,
    upstash: {
        url: upstashCfg.url,
        token: upstashCfg.read_token,
        index: upstashCfg.index
    },
    supabase: {
        url: supabaseCfg.url,
        key: supabaseCfg.pub_key,
        table: supabaseCfg.table || 'flux_search'
    }
  };
%>
<section class="post-index search-page" x-data='search(<%- JSON.stringify(frontendConfig) %>)'>
  <h1 class="post-title"><%= page.title || 'Search' %></h1>
  <div class="search-box">
    <div class="search-input-wrapper">
      <input type="text" id="local-search-input" placeholder="Enter keywords..." autocomplete="off" x-model.debounce.500ms="query" x-ref="searchInput">
      <button type="button" id="local-search-clear" class="search-clear-btn" aria-label="Clear search" @click="clearSearch()" x-show="query">
        &times;
      </button>
    </div>
  </div>
  <div class="search-status" x-show="isLoading" style="color:var(--muted); font-size:0.9rem; margin-bottom:1rem;" x-cloak>
    Searching...
  </div>
  <div class="search-status" x-show="error" x-text="error" style="color:var(--accent); font-size:0.9rem; margin-bottom:1rem;"></div>
  <div id="local-search-results" class="search-results">
    <template x-for="result in results" :key="result.url">
      <article class="post-card search-result">
        <h2 class="post-title">
          <a :href="result.url" x-text="result.title || '(Untitled)'"></a>
          <span class="result-lock" x-show="result.encrypted">
            <%- partial('partial/lock') %>
          </span>
        </h2>
        <div class="post-meta">
          <span x-text="result.type === 'project' ? 'Project' : 'Post'"></span>
          <span class="meta-sep" x-show="result.date">-</span>
          <time x-text="result.date ? new Date(result.date).toISOString().slice(0, 10) : ''"></time>
        </div>
        <div class="post-excerpt result-excerpt" x-html="result.excerpt || ''"></div>
      </article>
    </template>
    <div x-show="query && !results.length && !isLoading" style="color:var(--muted)" x-cloak>
      No results found.
    </div>
  </div>
</section>
<script src="<%= url_for('/js/search.js') %>"></script>